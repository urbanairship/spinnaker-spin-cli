{"application": "echo", "id": "24cabf8d-10a1-4c0b-bc76-9475aa26993d", "index": 1, "keepWaitingPipelines": false, "lastModifiedBy": "scott.frazier@airship.com", "limitConcurrent": true, "name": "Set image tag", "parameterConfig": [{"default": "echo-1", "description": "", "hasOptions": false, "label": "deployment", "name": "deployment", "options": [{"value": "bigtable-autoscaler-1"}, {"value": ""}], "pinned": true, "required": false}, {"default": "asdf123", "description": "", "hasOptions": false, "label": "tag", "name": "tag", "options": [{"value": "asdf123"}, {"value": ""}], "pinned": true, "required": false}], "schema": "1", "stages": [{"account": "gcb-account", "application": "echo", "buildDefinition": {"steps": [{"args": ["cp", "gs://ua-ops-deploy_cloudbuild/secrets/id_rsa.enc", "id_rsa.enc"], "id": "Get Github credentials", "name": "gcr.io/cloud-builders/gsutil", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["kms", "decrypt", "--ciphertext-file=id_rsa.enc", "--plaintext-file=/root/.ssh/id_rsa", "--location=global", "--keyring=cloudbuilder", "--key=github-key", "--project=ua-ops-deploy"], "id": "Decrypt Github credentials", "name": "gcr.io/cloud-builders/gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["-c", "chmod 600 /root/.ssh/id_rsa\ncat <<EOF >/root/.ssh/config\nHostname github.com\nIdentityFile /root/.ssh/id_rsa\nEOF\nssh-keyscan -t rsa github.com > known_hosts\nmv known_hosts /root/.ssh/known_hosts\ngit clone git@github.com:urbanairship/gcp-infrastructure\n"], "entrypoint": "bash", "id": "Clone gcp-infrastructure", "name": "gcr.io/cloud-builders/git", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["-c", "cd gcp-infrastructure\npip install ruamel.yaml\npython version.py --deployment ${parameters[\"deployment\"]} --tag ${parameters[\"tag\"]}\n"], "entrypoint": "bash", "id": "Change image tag", "name": "gcr.io/cloud-builders/git", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["-c", "cd gcp-infrastructure\ngit config --global user.name \"Spinnaker\"\ngit config --global user.email \"infra@urbanairship.com\"\ngit commit -am \"Automatic image tagging by Spinnaker\"\ngit pull\ngit push origin master\n"], "entrypoint": "bash", "id": "Push changes to gcp-infrastructure", "name": "gcr.io/cloud-builders/git", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}]}, "buildDefinitionSource": "text", "name": "Google Cloud Build", "refId": "1", "requisiteStageRefIds": [], "type": "googleCloudBuild"}], "triggers": [], "updateTs": "1600387484406"}
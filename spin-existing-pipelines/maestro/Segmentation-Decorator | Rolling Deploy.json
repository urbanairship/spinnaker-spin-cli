{"appConfig": {}, "application": "maestro", "id": "27470c79-c202-4c0a-83fc-36eada8a1b46", "index": 0, "keepWaitingPipelines": false, "lastModifiedBy": "florian.schmidt@airship.com", "limitConcurrent": true, "name": "Segmentation-Decorator | Rolling Deploy", "notifications": [{"address": "test-spinnaker", "level": "pipeline", "type": "slack", "when": ["pipeline.starting", "pipeline.complete", "pipeline.failed"]}], "parameterConfig": [{"default": "", "description": "Image version tag", "hasOptions": false, "label": "tag", "name": "tag", "options": [{"value": ""}], "pinned": true, "required": false}], "schema": "1", "spelEvaluator": "v4", "stages": [{"account": "gcb-account", "application": "decorator", "buildDefinition": {"steps": [{"args": ["-c", "gcloud secrets versions access latest --secret=${_SECRET} --project=ua-ops-secrets > /root/.ssh/id_rsa"], "entrypoint": "bash", "id": "Get github credentials", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["-c", "chmod 600 /root/.ssh/id_rsa\ncat <<EOF >/root/.ssh/config\nHostname github.com\nIdentityFile /root/.ssh/id_rsa\nEOF\nssh-keyscan -t rsa github.com > /root/.ssh/known_hosts\n"], "entrypoint": "bash", "id": "Setup Github config", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["clone", "git@github.com:urbanairship/gcp-infrastructure", "./"], "entrypoint": "git", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["-c", "python3 version.py --deployment ${_NAME} --tag ${parameters[\"tag\"]}\n"], "entrypoint": "bash", "id": "Update tag", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "git config --global user.name \"Spinnaker\"\ngit config --global user.email \"infra@urbanairship.com\"\ngit commit -am \"Automatic image tagging by Spinnaker\"\ngit pull --ff-only\ngit push origin master\n"], "entrypoint": "bash", "id": "Push changes", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}], "substitutions": {"_NAME": "maestro-segmentation-decorator-0", "_SECRET": "spinnaker-ua-ops-deploy-infra-source-password"}}, "buildDefinitionSource": "text", "name": "Set Version", "refId": "1", "requisiteStageRefIds": [], "stageEnabled": {"expression": "parameters['tag'] != null && parameters['tag'] != ''", "type": "expression"}, "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "decorator", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["-c", "gcloud secrets versions access latest --secret=${_SECRET} --project=ua-ops-secrets > /root/.ssh/id_rsa"], "entrypoint": "bash", "id": "Get github credentials", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["-c", "chmod 600 /root/.ssh/id_rsa\ncat <<EOF >/root/.ssh/config\nHostname github.com\nIdentityFile /root/.ssh/id_rsa\nEOF\nssh-keyscan -t rsa github.com > /root/.ssh/known_hosts\n"], "entrypoint": "bash", "id": "Setup Github config", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["clone", "git@github.com:urbanairship/gcp-infrastructure", "./"], "entrypoint": "git", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "maestro-segmentation-decorator-0", "_PROJECT": "ua-ops-transitional-stag", "_SECRET": "spinnaker-ua-ops-deploy-infra-source-password"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "comments": "<ul>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/compute/instanceGroups/details/us-east1/maestro-segmentation-decorator-0-igm?project=ua-ops-transitional-stag&amp;organizationId=272278969548\">Instance Group Dashboard</a></li>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&amp;project=ua-ops-transitional-stag&amp;organizationId=272278969548&amp;minLogLevel=0&amp;expandAll=false&amp;advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22%3A%22maestro-segmentation-decorator-0-instance%22\">Instance Group Logs</a></li>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&amp;project=ua-ops-transitional-stag&amp;organizationId=272278969548&amp;minLogLevel=0&amp;expandAll=false&amp;advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22%3A%22maestro-segmentation-decorator-0-instance%22%0AjsonPayload.serviceContext.version%3A%22${parameters[\"tag\"]}%22\">Instance Group Logs (just version ${parameters[\"tag\"]})</a></li>\n    <li><a target=\"_blank\" href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&project=ua-ops-transitional-stag&organizationId=272278969548&minLogLevel=0&expandAll=false&advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22:%22maestro-segmentation-decorator-0-instance%22%0AjsonPayload.CONTAINER_NAME%3D%22maestro-segmentation-decorator%22\">Container Logs</a></li>\n      <li><a target=\"_blank\" href=\"https://console.cloud.google.com/errors?service=maestro-segmentation-decorator&time=PT6H&order=COUNT_DESC&project=ua-ops-transitional-stag\">Error Reporting</a></li></ul>", "name": "Deploy to STAG", "refId": "2", "requisiteStageRefIds": ["1"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "decorator", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION} -m ${_MIN_READY}\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "curl -X POST -H \"Content-Length: 0\" 'https://iapproxy.airship.com/rundeck?job=720f49fd-c11b-4c81-a1ef-4855cff6dc2b'\n"], "entrypoint": "bash", "id": "QA Tests", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "maestro-segmentation-decorator-0", "_MIN_READY": "0s", "_PROJECT": "ua-ops-transitional-stag", "_REGION": "us-east1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "comments": "<ul>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/compute/instanceGroups/details/us-east1/maestro-segmentation-decorator-0-igm?project=ua-ops-transitional-stag&amp;organizationId=272278969548\">Instance Group Dashboard</a></li>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&amp;project=ua-ops-transitional-stag&amp;organizationId=272278969548&amp;minLogLevel=0&amp;expandAll=false&amp;advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22%3A%22maestro-segmentation-decorator-0-instance%22\">Instance Group Logs</a></li>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&amp;project=ua-ops-transitional-stag&amp;organizationId=272278969548&amp;minLogLevel=0&amp;expandAll=false&amp;advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22%3A%22maestro-segmentation-decorator-0-instance%22%0AjsonPayload.serviceContext.version%3A%22${parameters[\"tag\"]}%22\">Instance Group Logs (just version ${parameters[\"tag\"]})</a></li>\n    <li><a target=\"_blank\" href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&project=ua-ops-transitional-stag&organizationId=272278969548&minLogLevel=0&expandAll=false&advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22:%22maestro-segmentation-decorator-0-instance%22%0AjsonPayload.CONTAINER_NAME%3D%22maestro-segmentation-decorator%22\">Container Logs</a></li>\n      <li><a target=\"_blank\" href=\"https://console.cloud.google.com/errors?service=maestro-segmentation-decorator&time=PT6H&order=COUNT_DESC&project=ua-ops-transitional-stag\">Error Reporting</a></li></ul>", "name": "Update instances", "refId": "3", "requisiteStageRefIds": ["2"], "type": "googleCloudBuild"}, {"failPipeline": true, "instructions": "Please verify that your changes are working in staging before continuing the deploy.", "judgmentInputs": [], "name": "Continue  Deploy?", "notifications": [{"address": "${ trigger['user'] }", "level": "stage", "type": "email", "when": ["manualJudgment"]}], "refId": "4", "requisiteStageRefIds": ["3"], "restrictExecutionDuringTimeWindow": false, "restrictedExecutionWindow": {"days": [], "jitter": {"enabled": false, "maxDelay": 600, "minDelay": 0, "skipManual": false}, "whitelist": []}, "sendNotifications": true, "type": "manualJudgment"}, {"account": "gcb-account", "application": "decorator", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["-c", "gcloud secrets versions access latest --secret=${_SECRET} --project=ua-ops-secrets > /root/.ssh/id_rsa"], "entrypoint": "bash", "id": "Get github credentials", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["-c", "chmod 600 /root/.ssh/id_rsa\ncat <<EOF >/root/.ssh/config\nHostname github.com\nIdentityFile /root/.ssh/id_rsa\nEOF\nssh-keyscan -t rsa github.com > /root/.ssh/known_hosts\n"], "entrypoint": "bash", "id": "Setup Github config", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["clone", "git@github.com:urbanairship/gcp-infrastructure", "./"], "entrypoint": "git", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}", "waitFor": ["render"]}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "maestro-segmentation-decorator-0", "_PROJECT": "ua-ops-transitional-eucs", "_SECRET": "spinnaker-ua-ops-deploy-infra-source-password"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "name": "Deploy to EUCS", "refId": "5", "requisiteStageRefIds": ["4"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "decorator", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["/bin/ash", "-c", "./update_ig.py --method single --project ${_PROJECT} --region ${_REGION} --group ${_NAME}-igm\n"], "id": "update-ig", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "maestro-segmentation-decorator-0", "_PROJECT": "ua-ops-transitional-eucs", "_REGION": "europe-west1"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "comments": "<ul>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/compute/instanceGroups/details/europe-west1/maestro-segmentation-decorator-0-igm?project=ua-ops-transitional-eucs\">EUCS Instance Group</a></li>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/logs/viewer?project=ua-ops-transitional-eucs&minLogLevel=0&expandAll=false&resource=gce_instance&advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22:%22maestro-segmentation-decorator-0%22\">EUCS Instance Group Logs</a></li>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&amp;project=ua-ops-transitional-eucs&amp;organizationId=272278969548&amp;minLogLevel=0&amp;expandAll=false&amp;advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22%3A%22maestro-segmentation-decorator-0-instance%22%0AjsonPayload.serviceContext.version%3A%22${parameters[\"tag\"]}%22\">Instance Group Logs (just version ${parameters[\"tag\"]})</a></li>\n      <li><a target=\"_blank\" href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&project=ua-ops-transitional-eucs&organizationId=272278969548&minLogLevel=0&expandAll=false&advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22:%22maestro-segmentation-decorator-0-instance%22%0AjsonPayload.CONTAINER_NAME%3D%22maestro-segmentation-decorator%22\">Container Logs</a></li>\n      <li><a target=\"_blank\" href=\"https://console.cloud.google.com/errors?service=maestro-segmentation-decorator&time=PT6H&order=COUNT_DESC&project=ua-ops-transitional-eucs\">Error Reporting</a></li>\n</ul>", "name": "Canary", "refId": "6", "requisiteStageRefIds": ["5"], "type": "googleCloudBuild"}, {"completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "instructions": "Please verify that your changes are working on the canary before continuing the deploy.", "judgmentInputs": [], "name": "Continue EUCS Deploy?", "notifications": [], "refId": "7", "requisiteStageRefIds": ["6"], "sendNotifications": true, "type": "manualJudgment"}, {"account": "gcb-account", "application": "decorator", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION} -m ${_MIN_READY}\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "curl -X POST -H \"Content-Length: 0\" 'https://iapproxy.airship.com/rundeck?job=c0394610-e435-4862-bbc6-00fb98b1a3d1'\n"], "entrypoint": "bash", "id": "QA Tests", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "maestro-segmentation-decorator-0", "_MIN_READY": "0s", "_PROJECT": "ua-ops-transitional-eucs", "_REGION": "europe-west1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "comments": "<ul>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/compute/instanceGroups/details/europe-west1/maestro-segmentation-decorator-0-igm?project=ua-ops-transitional-eucs\">EUCS Instance Group</a></li>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/logs/viewer?project=ua-ops-transitional-eucs&minLogLevel=0&expandAll=false&resource=gce_instance&advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22:%22maestro-segmentation-decorator-0%22\">EUCS Instance Group Logs</a></li>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&amp;project=ua-ops-transitional-eucs&amp;organizationId=272278969548&amp;minLogLevel=0&amp;expandAll=false&amp;advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22%3A%22maestro-segmentation-decorator-0-instance%22%0AjsonPayload.serviceContext.version%3A%22${parameters[\"tag\"]}%22\">Instance Group Logs (just version ${parameters[\"tag\"]})</a></li>\n      <li><a target=\"_blank\" href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&project=ua-ops-transitional-eucs&organizationId=272278969548&minLogLevel=0&expandAll=false&advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22:%22maestro-segmentation-decorator-0-instance%22%0AjsonPayload.CONTAINER_NAME%3D%22maestro-segmentation-decorator%22\">Container Logs</a></li>\n      <li><a target=\"_blank\" href=\"https://console.cloud.google.com/errors?service=maestro-segmentation-decorator&time=PT6H&order=COUNT_DESC&project=ua-ops-transitional-eucs\">Error Reporting</a></li>\n</ul>", "name": "Update instances", "refId": "8", "requisiteStageRefIds": ["7"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "decorator", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["-c", "gcloud secrets versions access latest --secret=${_SECRET} --project=ua-ops-secrets > /root/.ssh/id_rsa"], "entrypoint": "bash", "id": "Get github credentials", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["-c", "chmod 600 /root/.ssh/id_rsa\ncat <<EOF >/root/.ssh/config\nHostname github.com\nIdentityFile /root/.ssh/id_rsa\nEOF\nssh-keyscan -t rsa github.com > /root/.ssh/known_hosts\n"], "entrypoint": "bash", "id": "Setup Github config", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["clone", "git@github.com:urbanairship/gcp-infrastructure", "./"], "entrypoint": "git", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}", "waitFor": ["render"]}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "maestro-segmentation-decorator-0", "_PROJECT": "ua-ops-transitional-prod", "_SECRET": "spinnaker-ua-ops-deploy-infra-source-password"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "name": "Deploy to PROD", "refId": "9", "requisiteStageRefIds": ["4"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "decorator", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["/bin/ash", "-c", "./update_ig.py --method single --project ${_PROJECT} --region ${_REGION} --group ${_NAME}-igm\n"], "id": "update-ig", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "maestro-segmentation-decorator-0", "_PROJECT": "ua-ops-transitional-prod", "_REGION": "us-east1"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "comments": "<ul>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/compute/instanceGroups/details/us-east1/maestro-segmentation-decorator-0-igm?project=ua-ops-transitional-prod\">PROD Instance Group</a></li>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/logs/viewer?project=ua-ops-transitional-prod&minLogLevel=0&expandAll=false&resource=gce_instance&advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22:%22maestro-segmentation-decorator-0%22\">PROD Instance Group Logs</a></li>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&amp;project=ua-ops-transitional-prod&amp;organizationId=272278969548&amp;minLogLevel=0&amp;expandAll=false&amp;advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22%3A%22maestro-segmentation-decorator-0-instance%22%0AjsonPayload.serviceContext.version%3A%22${parameters[\"tag\"]}%22\">Instance Group Logs (just version ${parameters[\"tag\"]})</a></li>\n      <li><a target=\"_blank\" href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&project=ua-ops-transitional-prod&organizationId=272278969548&minLogLevel=0&expandAll=false&advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22:%22maestro-segmentation-decorator-0-instance%22%0AjsonPayload.CONTAINER_NAME%3D%22maestro-segmentation-decorator%22\">Container Logs</a></li>\n      <li><a target=\"_blank\" href=\"https://console.cloud.google.com/errors?service=maestro-segmentation-decorator&time=PT6H&order=COUNT_DESC&project=ua-ops-transitional-prod\">Error Reporting</a></li>\n</ul>", "name": "Canary", "refId": "10", "requisiteStageRefIds": ["9"], "type": "googleCloudBuild"}, {"completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "instructions": "Please verify that your changes are working on the canary before continuing the deploy.", "judgmentInputs": [], "name": "Continue PROD Deploy?", "notifications": [], "refId": "11", "requisiteStageRefIds": ["10"], "sendNotifications": true, "type": "manualJudgment"}, {"account": "gcb-account", "application": "decorator", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION} -m ${_MIN_READY}\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "curl -X POST -H \"Content-Length: 0\" 'https://iapproxy.airship.com/rundeck?job=a4d0408f-9f15-47d5-9a54-a604c2eed97d'\n"], "entrypoint": "bash", "id": "QA Tests", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "maestro-segmentation-decorator-0", "_MIN_READY": "0s", "_PROJECT": "ua-ops-transitional-prod", "_REGION": "us-east1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "comments": "<ul>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/compute/instanceGroups/details/us-east1/maestro-segmentation-decorator-0-igm?project=ua-ops-transitional-prod\">PROD Instance Group</a></li>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/logs/viewer?project=ua-ops-transitional-prod&minLogLevel=0&expandAll=false&resource=gce_instance&advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22:%22maestro-segmentation-decorator-0%22\">PROD Instance Group Logs</a></li>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&amp;project=ua-ops-transitional-prod&amp;organizationId=272278969548&amp;minLogLevel=0&amp;expandAll=false&amp;advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22%3A%22maestro-segmentation-decorator-0-instance%22%0AjsonPayload.serviceContext.version%3A%22${parameters[\"tag\"]}%22\">Instance Group Logs (just version ${parameters[\"tag\"]})</a></li>\n      <li><a target=\"_blank\" href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&project=ua-ops-transitional-prod&organizationId=272278969548&minLogLevel=0&expandAll=false&advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22:%22maestro-segmentation-decorator-0-instance%22%0AjsonPayload.CONTAINER_NAME%3D%22maestro-segmentation-decorator%22\">Container Logs</a></li>\n      <li><a target=\"_blank\" href=\"https://console.cloud.google.com/errors?service=maestro-segmentation-decorator&time=PT6H&order=COUNT_DESC&project=ua-ops-transitional-prod\">Error Reporting</a></li>\n</ul>", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update instances", "notifications": [], "refId": "12", "requisiteStageRefIds": ["11"], "type": "googleCloudBuild"}], "triggers": [], "updateTs": "1673271200033"}
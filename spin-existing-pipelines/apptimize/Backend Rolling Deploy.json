{"appConfig": {}, "application": "apptimize", "expectedArtifacts": [], "id": "3220ed43-8884-4499-99df-f72c14fdbab9", "index": 2, "keepWaitingPipelines": false, "lastModifiedBy": "yinmeng.zhang@airship.com", "limitConcurrent": true, "name": "Backend Rolling Deploy", "notifications": [{"address": "test-spinnaker", "level": "pipeline", "type": "slack", "when": ["pipeline.complete", "pipeline.starting", "pipeline.failed"]}, {"address": "apptimize-deploy", "level": "pipeline", "type": "slack", "when": ["pipeline.starting", "pipeline.complete", "pipeline.failed"]}], "parameterConfig": [{"default": "", "description": "Image version tag (git hash from jenkins build)", "hasOptions": false, "label": "tag", "name": "tag", "options": [{"value": ""}], "pinned": true, "required": true}], "schema": "1", "spelEvaluator": "v4", "stages": [{"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-admin-1", "_PROJECT": "apptimize-stag"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy admin to stag", "refId": "1", "requisiteStageRefIds": ["24"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-restapi-1", "_PROJECT": "apptimize-stag"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy restapi to stag", "refId": "4", "requisiteStageRefIds": ["24"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-static-1", "_PROJECT": "apptimize-stag"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy static to stag", "refId": "5", "requisiteStageRefIds": ["24"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-admin-1", "_PROJECT": "apptimize-stag", "_REGION": "us-east1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update admin instances", "refId": "6", "requisiteStageRefIds": ["1"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-restapi-1", "_PROJECT": "apptimize-stag", "_REGION": "us-east1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update restapi instances", "refId": "9", "requisiteStageRefIds": ["4"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-static-1", "_PROJECT": "apptimize-stag", "_REGION": "us-east1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update static instances", "refId": "10", "requisiteStageRefIds": ["5"], "type": "googleCloudBuild"}, {"failPipeline": true, "instructions": "Please verify that your changes are working in staging before continuing the deploy.", "judgmentInputs": [], "name": "Manual Judgment", "notifications": [{"address": "apptimize-deploy", "level": "stage", "type": "slack", "when": ["manualJudgment", "manualJudgmentContinue", "manualJudgmentStop"]}], "refId": "11", "requisiteStageRefIds": ["6", "9", "10", "27", "35", "37"], "sendNotifications": true, "type": "manualJudgment"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["-c", "gcloud secrets versions access latest --secret=${_SECRET} --project=ua-ops-secrets > /root/.ssh/id_rsa"], "entrypoint": "bash", "id": "Get github credentials", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["-c", "chmod 600 /root/.ssh/id_rsa\ncat <<EOF >/root/.ssh/config\nHostname github.com\nIdentityFile /root/.ssh/id_rsa\nEOF\nssh-keyscan -t rsa github.com > known_hosts\nmv known_hosts /root/.ssh/known_hosts\n"], "entrypoint": "bash", "id": "Configure git", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["-c", "git clone git@github.com:urbanairship/gcp-infrastructure\n"], "entrypoint": "bash", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["-c", "cd gcp-infrastructure\npython3 version.py --deployment apptimize-backend-admin-1 --tag ${parameters[\"tag\"]}\npython3 version.py --deployment apptimize-backend-agg-1 --tag ${parameters[\"tag\"]}\npython3 version.py --deployment apptimize-backend-data-export-1 --tag ${parameters[\"tag\"]}\npython3 version.py --deployment apptimize-backend-misc-1 --tag ${parameters[\"tag\"]}\npython3 version.py --deployment apptimize-backend-restapi-1 --tag ${parameters[\"tag\"]}\npython3 version.py --deployment apptimize-backend-postproxy-1 --tag ${parameters[\"tag\"]}\npython3 version.py --deployment apptimize-backend-router-1 --tag ${parameters[\"tag\"]}\npython3 version.py --deployment apptimize-backend-static-1 --tag ${parameters[\"tag\"]}\npython3 version.py --deployment apptimize-backend-router-1 --tag ${parameters[\"tag\"]}\n"], "entrypoint": "bash", "id": "Update tag", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "cd gcp-infrastructure\ngit config --global user.name \"Spinnaker\"\ngit config --global user.email \"infra@urbanairship.com\"\ngit commit -am \"Automatic image tagging by Spinnaker\"\ngit pull\ngit push origin master\n"], "entrypoint": "bash", "id": "Push changes", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}], "substitutions": {"_SECRET": "spinnaker-ua-ops-deploy-infra-source-password"}}, "buildDefinitionSource": "text", "name": "Set image tag", "refId": "13", "requisiteStageRefIds": [], "stageEnabled": {"expression": "parameters['tag'] != null && parameters['tag'] != ''", "type": "expression"}, "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-misc-1", "_PROJECT": "apptimize-eucs"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy misc to eucs", "refId": "15", "requisiteStageRefIds": ["25"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-restapi-1", "_PROJECT": "apptimize-eucs"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy restapi to eucs", "refId": "16", "requisiteStageRefIds": ["25"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-static-1", "_PROJECT": "apptimize-eucs"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy static to eucs", "refId": "17", "requisiteStageRefIds": ["25"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-admin-1", "_PROJECT": "apptimize-eucs"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy admin to eucs", "refId": "18", "requisiteStageRefIds": ["25"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}  -s 0 -u 3\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-misc-1", "_PROJECT": "apptimize-eucs", "_REGION": "europe-west1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update misc instances", "refId": "20", "requisiteStageRefIds": ["15"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-restapi-1", "_PROJECT": "apptimize-eucs", "_REGION": "europe-west1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update restapi instances", "refId": "21", "requisiteStageRefIds": ["16"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-static-1", "_PROJECT": "apptimize-eucs", "_REGION": "europe-west1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update static instances", "refId": "22", "requisiteStageRefIds": ["17"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-admin-1", "_PROJECT": "apptimize-eucs", "_REGION": "europe-west1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update admin instances", "refId": "23", "requisiteStageRefIds": ["18"], "type": "googleCloudBuild"}, {"application": "apptimize", "failPipeline": true, "name": "Run DB Migration", "pipeline": "f94644d8-bd80-451a-a00a-f41f9af831ed", "pipelineParameters": {"instance": "apptimize-stag:us-east1:apptimize-primary-0", "secret": "apptimize-backend--apptimize-stag--db-password", "tag": "${ parameters['tag'] }"}, "refId": "24", "requisiteStageRefIds": ["13"], "stageEnabled": {"expression": "parameters['tag'] != null && parameters['tag'] != ''", "type": "expression"}, "type": "pipeline", "waitForCompletion": true}, {"application": "apptimize", "failPipeline": true, "name": "Run DB Migration EUCS", "pipeline": "f94644d8-bd80-451a-a00a-f41f9af831ed", "pipelineParameters": {"instance": "apptimize-eucs:europe-west1:apptimize-primary-0", "secret": "apptimize-backend--apptimize-eucs--db-password", "tag": "${ parameters['tag'] }"}, "refId": "25", "requisiteStageRefIds": ["11"], "stageEnabled": {"expression": "parameters['tag'] != null && parameters['tag'] != ''", "type": "expression"}, "type": "pipeline", "waitForCompletion": true}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-postproxy-1", "_PROJECT": "apptimize-stag"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy postproxy to stag", "refId": "26", "requisiteStageRefIds": ["24"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-postproxy-1", "_PROJECT": "apptimize-stag", "_REGION": "us-east1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update postproxy instances", "refId": "27", "requisiteStageRefIds": ["26"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-postproxy-1", "_PROJECT": "apptimize-eucs"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy postproxy to eucs", "refId": "28", "requisiteStageRefIds": ["25"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-postproxy-1", "_PROJECT": "apptimize-eucs", "_REGION": "europe-west1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update postproxy instances", "refId": "29", "requisiteStageRefIds": ["28"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-router-1", "_PROJECT": "apptimize-stag"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "name": "Deploy router to stag", "refId": "34", "requisiteStageRefIds": ["24"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}  -s 0 -u 3\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-router-1", "_PROJECT": "apptimize-stag", "_REGION": "us-east1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "name": "Update router instances", "refId": "35", "requisiteStageRefIds": ["34"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-misc-1", "_PROJECT": "apptimize-stag"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy misc to stag", "refId": "36", "requisiteStageRefIds": ["24"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}  -s 0 -u 3\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-misc-1", "_PROJECT": "apptimize-stag", "_REGION": "us-east1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update misc instances", "refId": "37", "requisiteStageRefIds": ["36"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-restapi-1", "_PROJECT": "apptimize-prod"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy restapi to prod", "refId": "38", "requisiteStageRefIds": ["40"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION} -s 99\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-restapi-1", "_PROJECT": "apptimize-prod", "_REGION": "us-east1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update restapi instances", "refId": "39", "requisiteStageRefIds": ["38"], "type": "googleCloudBuild"}, {"application": "apptimize", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Run DB Migration Prod", "pipeline": "f94644d8-bd80-451a-a00a-f41f9af831ed", "pipelineParameters": {"instance": "apptimize-prod:us-east1:apptimize-primary-0", "secret": "apptimize-backend--apptimize-prod--db-password", "tag": "${ parameters['tag'] }"}, "refId": "40", "requisiteStageRefIds": ["11"], "type": "pipeline", "waitForCompletion": true}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-static-1", "_PROJECT": "apptimize-prod"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy static to prod", "refId": "41", "requisiteStageRefIds": ["40"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION} -s 99\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-static-1", "_PROJECT": "apptimize-prod", "_REGION": "us-east1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update static instances", "refId": "42", "requisiteStageRefIds": ["41"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-postproxy-1", "_PROJECT": "apptimize-prod"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy postproxy to prod", "refId": "43", "requisiteStageRefIds": ["40"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION} -s 99\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-postproxy-1", "_PROJECT": "apptimize-prod", "_REGION": "us-east1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update postproxy instances", "refId": "44", "requisiteStageRefIds": ["43"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-admin-1", "_PROJECT": "apptimize-prod"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy admin to prod", "refId": "45", "requisiteStageRefIds": ["40"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-admin-1", "_PROJECT": "apptimize-prod", "_REGION": "us-east1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Update admin instances", "refId": "46", "requisiteStageRefIds": ["45"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-misc-1", "_PROJECT": "apptimize-prod"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy misc to prod", "refId": "49", "requisiteStageRefIds": ["40"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}  -s 0 -u 3\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-misc-1", "_PROJECT": "apptimize-prod", "_REGION": "us-east1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "name": "Update  misc instances", "refId": "50", "requisiteStageRefIds": ["49"], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_NAME}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_NAME}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_NAME}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_NAME}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_NAME": "apptimize-backend-router-1", "_PROJECT": "apptimize-eucs"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": true, "continuePipeline": false, "failPipeline": false, "name": "Deploy router to eucs", "notifications": [{"address": "apptimize-deploy", "level": "stage", "type": "slack", "when": ["stage.starting"]}], "refId": "51", "requisiteStageRefIds": ["25"], "restrictExecutionDuringTimeWindow": false, "restrictedExecutionWindow": {"days": [3], "whitelist": [{"endHour": 20, "endMin": 0, "startHour": 18, "startMin": 0}]}, "sendNotifications": false, "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "python3 tools/rolling_deploy.py -d ${_DEPLOYMENT} -p ${_PROJECT} -r ${_REGION}  -s 0 -u 3\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_DEPLOYMENT": "apptimize-backend-router-1", "_PROJECT": "apptimize-eucs", "_REGION": "europe-west1"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "name": "Update router instances", "refId": "52", "requisiteStageRefIds": ["51"], "type": "googleCloudBuild"}], "triggers": [{"attributeConstraints": {"image": "apptimize-backend"}, "enabled": true, "expectedArtifactIds": [], "payloadConstraints": {}, "pubsubSystem": "google", "subscriptionName": "jenkins-pub-sub", "type": "pubsub"}], "updateTs": "1694113002485"}
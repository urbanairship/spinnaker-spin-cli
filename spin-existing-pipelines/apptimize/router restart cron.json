{"application": "apptimize", "description": "Details about description with example configs", "expectedArtifacts": [], "id": "058221c0-1b9c-4832-96da-db794a666e08", "index": 9, "keepWaitingPipelines": false, "lastModifiedBy": "yinmeng.zhang@airship.com", "limitConcurrent": false, "name": "router restart cron", "notifications": [{"address": "test-spinnaker", "level": "pipeline", "type": "slack", "when": ["pipeline.complete", "pipeline.starting", "pipeline.failed"]}], "parameterConfig": [{"default": "apptimize-prod", "description": "", "hasOptions": true, "label": "project", "name": "project", "options": [{"value": "apptimize-stag"}, {"value": "apptimize-eucs"}, {"value": "apptimize-prod"}], "pinned": true, "required": true}, {"default": "apptimize-backend-router-1", "description": "Currently this pipeline only applies to router; some variables are hardcoded to router values", "hasOptions": true, "label": "service", "name": "service", "options": [{"value": "apptimize-backend-router-1"}], "pinned": false, "required": true}], "schema": "1", "spelEvaluator": "v4", "stages": [{"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["-c", "gcloud secrets versions access latest --secret=${_SECRET} --project=ua-ops-secrets > /root/.ssh/id_rsa"], "entrypoint": "bash", "id": "Get github credentials", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["-c", "chmod 600 /root/.ssh/id_rsa\ncat <<EOF >/root/.ssh/config\nHostname github.com\nIdentityFile /root/.ssh/id_rsa\nEOF\nssh-keyscan -t rsa github.com > /root/.ssh/known_hosts\n"], "entrypoint": "bash", "id": "Setup Github config", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["clone", "git@github.com:urbanairship/gcp-infrastructure", "./"], "entrypoint": "git", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud", "volumes": [{"name": "ssh", "path": "/root/.ssh"}]}, {"args": ["/bin/ash", "-c", "echo \"GCP DEPLOY:\"\necho \"- DEPLOY: ${_SERVICE}\"\necho \"- PROJECT: ${_PROJECT}\"\necho \"CHOOCHER:\"\necho \"- VERSION: ${_CHOOCHER_VER}\"\necho \"- LOG_LEVEL: ${_CHOOCHER_LOG_LEVEL}\"\n"], "id": "info", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["render", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--env=project=${_PROJECT},deployment=${_SERVICE}", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_SERVICE}"], "id": "render", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}, {"args": ["-c", "python3 check_tags_exist.py --deployment ${_SERVICE}\n"], "entrypoint": "bash", "id": "Check artifact exists", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["deploy", "--project=${_PROJECT}", "--deployment=deployments.yaml", "--log-level=${_CHOOCHER_LOG_LEVEL}", "${_SERVICE}"], "id": "deploy", "name": "gcr.io/ua-ops-artifacts/choocher:${_CHOOCHER_VER}"}], "substitutions": {"_CHOOCHER_LOG_LEVEL": "INFO", "_CHOOCHER_VER": "v6.0.0", "_PROJECT": "${parameters[\"project\"]}", "_SECRET": "spinnaker-ua-ops-deploy-infra-source-password", "_SERVICE": "${parameters[\"service\"]}"}, "timeout": "1800s"}, "buildDefinitionSource": "text", "comments": "<ul>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/compute/instanceGroups/details/us-east1/apptimize-dashboard-api-1-igm?project=apptimize-stag&amp;organizationId=272278969548\">Instance Group Dashboard</a></li>\n      <li><a target=\"_blank\"  href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&amp;project=apptimize-stag&amp;organizationId=272278969548&amp;minLogLevel=0&amp;expandAll=false&amp;advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22%3A%22apptimize-dashboard-api-1-instance%22\">Instance Group Logs</a></li>\n    <li><a target=\"_blank\" href=\"https://console.cloud.google.com/logs/viewer?resource=gce_instance&project=apptimize-stag&organizationId=272278969548&minLogLevel=0&expandAll=false&advancedFilter=resource.type%3D%22gce_instance%22%0Alabels.%22compute.googleapis.com%2Fresource_name%22:%22apptimize-dashboard-api-1-instance%22%0AjsonPayload.CONTAINER_NAME%3D%22nginx-maintenance%22\">Container Logs</a></li></ul>", "completeOtherBranchesThenFail": false, "continuePipeline": true, "failPipeline": false, "name": "Deploy router template", "notifications": [], "refId": "14", "requisiteStageRefIds": [], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["-c", "echo lol\n"], "entrypoint": "bash", "id": "echo lol", "name": "ubuntu"}], "timeout": "3600s"}, "buildDefinitionSource": "text", "completeOtherBranchesThenFail": false, "continuePipeline": true, "failPipeline": false, "name": "echo hello", "refId": "15", "requisiteStageRefIds": [], "type": "googleCloudBuild"}, {"account": "gcb-account", "application": "apptimize", "buildDefinition": {"steps": [{"args": ["source", "repos", "clone", "github_urbanairship_gcp-infrastructure", "./", "--project=ua-ops-deploy"], "entrypoint": "gcloud", "id": "Clone gcp-infrastructure", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}, {"args": ["-c", "\nargs=\"-s ${_SURGE} -u ${_UNAVAIL}\"\necho \"$args\"\nif [[ ${_PROJECT} == 'apptimize-eucs' ]]; then\n  region=\"europe-west1\"\n  zone=\"europe-west1-b\"\nelse\n  region=${_REGION}\n  zone=${_ZONE}\nfi\necho \"$region\" echo \"$zone\"\n\nif [[ ${_TYPE} == 'regional' ]]; then\n  location=\"$region\"\n  arg=\"-r\"\nelse\n  location=\"$zone\"\n  arg=\"-z\"\n  args=\"-s 0 -u 3\"\nfi\necho \"$location\" echo \"$arg\"\npython3 tools/rolling_deploy.py -d ${_SERVICE} -p ${_PROJECT} $arg $location $args\n"], "entrypoint": "bash", "id": "Rolling Update", "name": "gcr.io/ua-ops-artifacts/spinnaker-gcloud"}], "substitutions": {"_PROJECT": "${parameters[\"project\"]}", "_REGION": "us-east1", "_SERVICE": "${parameters[\"service\"]}", "_SURGE": "0", "_TYPE": "regional", "_UNAVAIL": "3", "_ZONE": "us-east1-b"}, "timeout": "3600s"}, "buildDefinitionSource": "text", "name": "Update router instance", "refId": "16", "requisiteStageRefIds": ["14"], "type": "googleCloudBuild"}], "triggers": [{"cronExpression": "0 0 0 ? * SUN *", "enabled": true, "id": "11028c65-4e67-466e-ab61-dce171f9508c", "type": "cron"}], "updateTs": "1684127194035"}
{"application": "apptimize", "id": "f94644d8-bd80-451a-a00a-f41f9af831ed", "index": 4, "keepWaitingPipelines": false, "lastModifiedBy": "yinmeng.zhang@airship.com", "limitConcurrent": true, "name": "Flyway DB Migration", "parameterConfig": [{"default": "latest", "description": "Tag of backend docker image", "hasOptions": false, "label": "tag", "name": "tag", "options": [{"value": ""}], "pinned": true, "required": true}, {"default": "", "description": "SQL connection name", "hasOptions": true, "label": "instance", "name": "instance", "options": [{"value": "apptimize-stag:us-east1:apptimize-primary-0"}, {"value": "apptimize-eucs:europe-west1:apptimize-primary-0"}, {"value": "apptimize-prod:us-east1:apptimize-primary-0"}], "pinned": false, "required": true}, {"default": "", "description": "Secret for DB password", "hasOptions": true, "label": "secret", "name": "secret", "options": [{"value": "apptimize-backend--apptimize-stag--db-password"}, {"value": "apptimize-backend--apptimize-eucs--db-password"}, {"value": "apptimize-backend--apptimize-prod--db-password"}], "pinned": false, "required": true}], "schema": "1", "spelEvaluator": "v4", "stages": [{"account": "gcb-account", "application": "apptimize", "buildDefinition": {"options": {"substitutionOption": "ALLOW_LOOSE"}, "steps": [{"args": ["run", "-d", "--name=cloudsqlproxy", "--network=cloudbuild", "-p=5432:5432", "gcr.io/cloudsql-docker/gce-proxy:1.16", "/cloud_sql_proxy", "-dir=/cloudsql", "-instances=${_INSTANCE_CONNECTION_NAME}=tcp:0.0.0.0:5432"], "id": "Start cloud sql proxy", "name": "gcr.io/cloud-builders/docker"}, {"args": ["-c", "gcloud secrets versions access latest --secret=${_SECRET} --project=ua-ops-secrets > decrypted-secrets.txt"], "entrypoint": "bash", "id": "Get secrets", "name": "gcr.io/cloud-builders/gcloud"}, {"args": ["run", "--name=flyway", "--network=cloudbuild", "--env-file=decrypted-secrets.txt", "gcr.io/ua-ops-artifacts/apptimize-backend:${_IMAGE_TAG}", "com.apptimize.db.FlywayRunner", "configs/flyway.yaml"], "id": "Apply flyway migrations", "name": "gcr.io/cloud-builders/docker"}], "substitutions": {"_IMAGE_TAG": "${parameters[\"tag\"]}", "_INSTANCE_CONNECTION_NAME": "${parameters[\"instance\"]}", "_SECRET": "${parameters[\"secret\"]}"}}, "buildDefinitionSource": "text", "name": "Google Cloud Build", "refId": "1", "requisiteStageRefIds": [], "type": "googleCloudBuild"}], "triggers": [], "updateTs": "1627576495811"}